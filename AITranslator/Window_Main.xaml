<Window x:Class="AITranslator.Window_Main"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expsression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:calc="clr-namespace:CalcBinding;assembly=CalcBinding"
        xmlns:tb="clr-namespace:H.NotifyIcon;assembly=H.NotifyIcon.Wpf"
        xmlns:local="clr-namespace:AITranslator"
        xmlns:vm="clr-namespace:AITranslator.View.Models"
        mc:Ignorable="d"
        Title="AI Translator" SizeToContent="Height" Height="Auto" Width="400" WindowStyle="None" ResizeMode="NoResize" WindowStartupLocation="CenterScreen" Background="Transparent" AllowsTransparency="True" Closing="window_main_Closing">
    <Window.RenderTransform>
        <TransformGroup>
            <ScaleTransform CenterX="{calc:Binding ActualWidth/2,RelativeSource={RelativeSource Mode=FindAncestor,AncestorType={x:Type Window}}}" CenterY="{calc:Binding ActualHeight/2,RelativeSource={RelativeSource Mode=FindAncestor,AncestorType={x:Type Window}}}" x:Name="window_scale"/>
            <TranslateTransform x:Name="window_translate"/>
        </TransformGroup>
    </Window.RenderTransform>
    <Window.Triggers>
        <EventTrigger RoutedEvent="Window.Loaded" >
            <BeginStoryboard>
                <Storyboard x:Name="anim">
                    <DoubleAnimation Duration="00:00:0.3"  Storyboard.TargetProperty="Opacity" From="0" To="1" />
                    <DoubleAnimation Storyboard.TargetName="window_scale" Duration="00:00:0.3" Storyboard.TargetProperty="ScaleX" From="0.9" To="1" />
                    <DoubleAnimation Storyboard.TargetName="window_scale" Duration="00:00:0.3" Storyboard.TargetProperty="ScaleY" From="0.9" To="1" />
                </Storyboard>
            </BeginStoryboard>
        </EventTrigger>
    </Window.Triggers>
    <Window.DataContext>
        <vm:ViewModel/>
    </Window.DataContext>
    <Border x:Name="border_Main" CornerRadius="10" BorderThickness="0">
        <Border.Background>
            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                <GradientStop Offset="1" Color="#FF21252D"/>
                <GradientStop Offset="0" Color="#FF273146"/>
            </LinearGradientBrush>
        </Border.Background>
        <Border.BorderBrush>
            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                <GradientStop Offset="0" Color="#FF6B6C6D"/>
                <GradientStop Offset="1" Color="#FF464646"/>
            </LinearGradientBrush>
        </Border.BorderBrush>
        <Grid>
            <Grid.Clip>
                <RectangleGeometry Rect="0 0 400 1000" RadiusX="9" RadiusY="9"></RectangleGeometry>
            </Grid.Clip>
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition/>
                    <RowDefinition/>
                    <RowDefinition/>
                </Grid.RowDefinitions>

                <!--标题栏-->
                <Grid Height="30" Background="#FF191D25" MouseLeftButtonDown="Header_MouseLeftButtonDown">
                    <StackPanel Orientation="Horizontal" Margin="10,3,0,0" Grid.ColumnSpan="2" HorizontalAlignment="Left" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Title,RelativeSource={RelativeSource Mode=FindAncestor,AncestorType={x:Type Window}}}" FontFamily="{StaticResource English}" VerticalAlignment="Center" FontSize="20" Foreground="#FFD2D9DC"/>
                        <TextBlock Margin="10,0,0,0" Text="{Binding Version,StringFormat=v{0}}" FontFamily="{StaticResource English}" FontSize="12" Foreground="#FFD2D9DC" VerticalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Margin="5,0,2,0" Grid.Column="1" HorizontalAlignment="Right" Orientation="Horizontal" >
                        <Button Style="{StaticResource TitleBarButton}" Click="Button_Set_Click" IsEnabled="{calc:Binding 'Progress >= 100 or (IsBreaked and !IsTranslating)'}" Visibility="{calc:Binding 'Opacity != 0',FalseToVisibility=Collapsed,RelativeSource={RelativeSource Mode=Self}}">
                            <Viewbox Margin="1,3,1,1" VerticalAlignment="Center">
                                <Path Data="M944.48 552.458667l-182.357333 330.666666a73.792 73.792 0 0 1-64.565334 38.325334h-362.133333a73.792 73.792 0 0 1-64.565333-38.325334l-182.357334-330.666666a75.338667 75.338667 0 0 1 0-72.682667l182.357334-330.666667a73.792 73.792 0 0 1 64.565333-38.325333h362.133333a73.792 73.792 0 0 1 64.565334 38.325333l182.357333 330.666667a75.338667 75.338667 0 0 1 0 72.682667z m-55.989333-31.146667a10.773333 10.773333 0 0 0 0-10.378667l-182.037334-330.666666a10.517333 10.517333 0 0 0-9.205333-5.482667H335.733333a10.517333 10.517333 0 0 0-9.205333 5.482667l-182.037333 330.666666a10.773333 10.773333 0 0 0 0 10.378667l182.037333 330.666667a10.517333 10.517333 0 0 0 9.205333 5.472h361.514667a10.517333 10.517333 0 0 0 9.205333-5.472l182.037334-330.666667zM513.738667 682.666667c-94.261333 0-170.666667-76.405333-170.666667-170.666667s76.405333-170.666667 170.666667-170.666667c94.250667 0 170.666667 76.405333 170.666666 170.666667s-76.416 170.666667-170.666666 170.666667z m0-64c58.912 0 106.666667-47.754667 106.666666-106.666667s-47.754667-106.666667-106.666666-106.666667-106.666667 47.754667-106.666667 106.666667 47.754667 106.666667 106.666667 106.666667z"
                                  Fill="{Binding Foreground, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type Button}}}"/>
                            </Viewbox>
                        </Button>
                        <Button Style="{StaticResource TitleBarButton}" Click="Button_Small_Click">
                            <Label Content="-" Margin="-5" Foreground="{Binding Foreground, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type Button}}}" VerticalContentAlignment="Center" HorizontalContentAlignment="Center" FontSize="18"/>
                        </Button>
                        <Button Style="{StaticResource TitleBarButton}" Click="Button_Close_Click">
                            <Label Content="×" Margin="-5" Foreground="{Binding Foreground, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type Button}}}" VerticalContentAlignment="Center" HorizontalContentAlignment="Center" FontSize="18"/>
                        </Button>
                    </StackPanel>
                    <!--托盘图标-->
                    <tb:TaskbarIcon x:Name="tbIcon" PopupPlacement="MousePoint" Visibility="Collapsed" PopupActivation="RightClick" IconSource="pack://application:,,,/AITranslator;component/View/Resources/Icon/Icon.ico" TrayLeftMouseDown="tbIcon_TrayLeftMouseDoubleClick">
                        <tb:TaskbarIcon.ToolTipText>
                            <MultiBinding Converter="{StaticResource TaskbarIconToolTipText}">
                                <Binding Path="IsTranslating"/>
                                <Binding Path="IsBreaked"/>
                                <Binding Path="Progress"/>
                            </MultiBinding>
                        </tb:TaskbarIcon.ToolTipText>
                        <tb:TaskbarIcon.TrayPopup>
                            <Border Padding="5,8" CornerRadius="5" Width="120">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Offset="1" Color="#FF21252D"/>
                                        <GradientStop Offset="0" Color="#FF273146"/>
                                    </LinearGradientBrush>
                                </Border.Background>

                                <StackPanel Grid.Row="0">
                                    <Button Height="25" IsEnabled="True" Visibility="{calc:Binding 'Height != 0',FalseToVisibility=Collapsed,RelativeSource={RelativeSource Mode=Self}}" Style="{StaticResource TaskbarButton}" Click="Button_Start_Taskbar_Click">
                                        <Button.Content>
                                            <MultiBinding Converter="{StaticResource StartButtonText}" ConverterParameter="暂停 继续 开始 查看">
                                                <Binding Path="IsTranslating"/>
                                                <Binding Path="IsBreaked"/>
                                                <Binding Path="Progress"/>
                                            </MultiBinding>
                                        </Button.Content>
                                    </Button>
                                    <Button IsEnabled="{calc:Binding 'Progress >= 100 or (IsBreaked and !IsTranslating)'}"  Visibility="{calc:Binding 'Height != 0',FalseToVisibility=Collapsed,RelativeSource={RelativeSource Mode=Self}}" Height="25" Style="{StaticResource TaskbarButton}" Content="清除当前进度" Click="Button_Clear_Taskbar_Click"/>
                                    <Button Height="25" Style="{StaticResource TaskbarButton}" Content="退出" Click="Button_Close_Taskbar_Click"/>
                                </StackPanel>
                            </Border>
                        </tb:TaskbarIcon.TrayPopup>
                    </tb:TaskbarIcon>
                </Grid>
                <!--主体-->
                <Grid Margin="5,5,5,0" Grid.Row="1">
                    <Grid.RowDefinitions>
                        <RowDefinition/>
                        <RowDefinition/>
                    </Grid.RowDefinitions>
                    <!--按钮区-->
                    <StackPanel Grid.Row="0">
                        <Button Margin="0,0,0,5" Height="25" IsEnabled="True" Visibility="{calc:Binding 'Height != 0',FalseToVisibility=Collapsed,RelativeSource={RelativeSource Mode=Self}}" Style="{StaticResource ViewButton}" Click="Button_Start_Click">
                            <Button.Content>
                                <MultiBinding Converter="{StaticResource StartButtonText}" ConverterParameter="暂停 继续 开始 查看">
                                    <Binding Path="IsTranslating"/>
                                    <Binding Path="IsBreaked"/>
                                    <Binding Path="Progress"/>
                                </MultiBinding>
                            </Button.Content>
                        </Button>
                        <Button Margin="0,0,0,5" IsEnabled="{calc:Binding 'Progress >= 100 or (IsBreaked and !IsTranslating)'}"  Visibility="{calc:Binding 'Height != 0',FalseToVisibility=Collapsed,RelativeSource={RelativeSource Mode=Self}}" Height="25" Style="{StaticResource ViewButton}" Content="清除当前进度" Click="Button_Clear_Click"/>
                    </StackPanel>
                    <!--进度区-->
                    <Grid Margin="0,5,0,8" Grid.Row="1" Height="20">
                        <StackPanel Orientation="Horizontal">
                            <Border HorizontalAlignment="Left" Width="150" CornerRadius="5" BorderBrush="White" BorderThickness="1">
                                <Grid >
                                    <Grid.Clip>
                                        <RectangleGeometry Rect="0 0 148 18" RadiusX="5" RadiusY="5"/>
                                    </Grid.Clip>
                                    <ProgressBar Foreground="MediumPurple" BorderThickness="0" Value="{Binding Progress}" Maximum="100" Background="Transparent"/>
                                    <TextBlock VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="White" Text="{Binding Progress,StringFormat={}{0:0.00}%}"/>
                                </Grid>
                            </Border>

                            <TextBlock Visibility="{calc:Binding IsTranslating,FalseToVisibility=Hidden}" VerticalAlignment="Center" Foreground="White" Margin="5,3,0,0" Text="翻译中……"/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" >
                            <CheckBox x:Name="cb_ShowConsoles" Style="{StaticResource CheckButton}" Width="30" Content="日志"  Checked="cb_ShowConsoles_Checked" Unchecked="cb_ShowConsoles_Unchecked"/>
                        </StackPanel>
                    </Grid>
                </Grid>
                <!--控制台-->
                <Border x:Name="view_Consoles" Padding="0" Background="Black" CornerRadius="5" Height="0" Visibility="{calc:Binding 'Height != 0',FalseToVisibility=Collapsed,RelativeSource={RelativeSource Mode=Self}}" BorderBrush="White" Grid.Row="2" BorderThickness="0" Margin="5,0,5,8" >
                    <ListBox x:Name="list_Consoles" Background="Transparent" BorderThickness="0" ItemsSource="{Binding Consoles}" ScrollViewer.CanContentScroll="False" VirtualizingPanel.IsVirtualizing="True" VirtualizingPanel.VirtualizationMode="Standard" ScrollViewer.HorizontalScrollBarVisibility="Hidden" ScrollViewer.VerticalScrollBarVisibility="Hidden">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="FocusVisualStyle" Value="{x:Null}" />
                                <Setter Property="IsEnabled" Value="False"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="{x:Type ListBoxItem}">
                                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock TextWrapping="Wrap" Foreground="Gray" FocusVisualStyle="{x:Null}"  Width="{calc:Binding '(ActualWidth - 5) less 0 ? 0 : (ActualWidth - 5)',ElementName=list_Consoles}" Text="{Binding}"/>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Border>

            </Grid>
        </Grid>
    </Border>
</Window>
